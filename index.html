<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>For Dinda</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
  font-family:system-ui, sans-serif;
}
canvas{display:block}

/* camera preview */
#camPreview{
  position:fixed;
  right:10px;
  bottom:10px;
  width:110px;
  height:160px;
  object-fit:cover;
  border-radius:14px;
  opacity:0.18;
  filter:blur(.5px);
  z-index:5;
  transition:opacity .8s ease;
  pointer-events:none;
}

/* gesture hint */
#hint{
  position:fixed;
  bottom:14px;
  left:50%;
  transform:translateX(-50%);
  font-size:12px;
  color:rgba(255,255,255,.25);
  letter-spacing:.3px;
  z-index:4;
  user-select:none;
}
</style>
</head>

<body>
<video id="camPreview" autoplay playsinline muted></video>
<div id="hint">✋ open · ✊ close</div>

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/geometries/TextGeometry.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ===================== SCENE ===================== */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x050010,8,30);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,100);
camera.position.z=12;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
document.body.appendChild(renderer.domElement);

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* ===================== STARS ===================== */
const starCount=1800;
const starGeo=new THREE.BufferGeometry();
const pos=new Float32Array(starCount*3);

for(let i=0;i<starCount;i++){
  pos[i*3]=(Math.random()-.5)*30;
  pos[i*3+1]=(Math.random()-.5)*30;
  pos[i*3+2]=(Math.random()-.5)*30;
}
starGeo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const starMat=new THREE.PointsMaterial({
  color:0xffffff,
  size:.04,
  transparent:true,
  opacity:.9,
  depthWrite:false
});

const stars=new THREE.Points(starGeo,starMat);
scene.add(stars);

/* ===================== TEXT ===================== */
let textMesh=null;
const fontLoader=new FontLoader();

function showText(){
  fontLoader.load(
    "https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",
    font=>{
      const geo=new THREE.TextGeometry(
        "I am sorry, Dinda.\nFor the times my love\narrived as pain,\nnot care.",
        {
          font,
          size:.6,
          height:.25,
          curveSegments:12,
          bevelEnabled:true,
          bevelThickness:.03,
          bevelSize:.02,
          bevelSegments:5
        }
      );
      geo.center();

      const mat=new THREE.MeshStandardMaterial({
        color:0xffd9ff,
        emissive:0x662266,
        emissiveIntensity:.9,
        roughness:.2,
        metalness:.1
      });

      textMesh=new THREE.Mesh(geo,mat);
      textMesh.position.z=-1;
      scene.add(textMesh);

      camPreview.style.opacity=.18; // show preview again
    }
  );
}

scene.add(new THREE.PointLight(0xff88ff,1.4,20));
scene.add(new THREE.AmbientLight(0x333344));

/* ===================== ANIMATION STATES ===================== */
let state="idle";
let t=0;

function triggerApology(){
  if(state!=="idle")return;
  state="gather";
  camPreview.style.opacity=0; // hide preview
}

function resetAll(){
  if(textMesh){
    scene.remove(textMesh);
    textMesh=null;
  }
  state="idle";
}

/* ===================== LOOP ===================== */
function animate(){
  requestAnimationFrame(animate);
  t+=.002;

  stars.rotation.y+=.0006;
  stars.rotation.x+=.0003;

  const arr=starGeo.attributes.position.array;

  if(state==="gather"){
    for(let i=0;i<starCount;i++){
      arr[i*3]*=.96;
      arr[i*3+1]*=.96;
      arr[i*3+2]*=.96;
    }
    starGeo.attributes.position.needsUpdate=true;
    if(Math.abs(arr[0])<.02){
      state="explode";
    }
  }

  if(state==="explode"){
    for(let i=0;i<starCount;i++){
      arr[i*3]+=(Math.random()-.5)*.6;
      arr[i*3+1]+=(Math.random()-.5)*.6;
      arr[i*3+2]+=(Math.random()-.5)*.6;
    }
    starGeo.attributes.position.needsUpdate=true;
    state="text";
    showText();
  }

  renderer.render(scene,camera);
}
animate();

/* ===================== MEDIAPIPE ===================== */
const camPreview=document.getElementById("camPreview");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:0,
  minDetectionConfidence:.6,
  minTrackingConfidence:.6
});

hands.onResults(res=>{
  if(!res.multiHandLandmarks)return;
  const lm=res.multiHandLandmarks[0];
  const open=lm[8].y<lm[6].y && lm[12].y<lm[10].y;
  const fist=lm[8].y>lm[6].y && lm[12].y>lm[10].y;

  if(open)triggerApology();
  if(fist)resetAll();
});

new Camera(camPreview,{
  onFrame:async()=>hands.send({image:camPreview}),
  width:640,
  height:480
}).start();
</script>
</body>
</html>
