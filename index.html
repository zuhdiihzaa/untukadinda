<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>For Dinda</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:black;
  font-family:serif;
}
#video{
  position:fixed;
  left:12px;
  bottom:12px;
  width:110px;
  height:150px;
  object-fit:cover;
  border-radius:14px;
  opacity:.85;
  transform:scaleX(-1);
  z-index:5;
}
#hint{
  position:fixed;
  bottom:12px;
  right:12px;
  color:#aaa;
  font-size:12px;
  opacity:.6;
  z-index:5;
}
</style>
</head>

<body>
<video id="video" autoplay muted playsinline></video>
<div id="hint">âœ‹ change gesture</div>

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155/build/three.min.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================== SCENE ================== */
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
  60,
  innerWidth/innerHeight,
  0.1,
  100
);
camera.position.z = 10;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

/* ================== GALAXY ================== */
const starCount = 2000;
const geometry = new THREE.BufferGeometry();
const positions = new Float32Array(starCount*3);
const speeds = new Float32Array(starCount);

for(let i=0;i<starCount;i++){
  positions[i*3] = (Math.random()-.5)*40;
  positions[i*3+1] = (Math.random()-.5)*40;
  positions[i*3+2] = (Math.random()-.5)*40;
  speeds[i] = Math.random()*0.003 + 0.001;
}

geometry.setAttribute(
  "position",
  new THREE.BufferAttribute(positions,3)
);

const material = new THREE.PointsMaterial({
  color:0x88aaff,
  size:0.08,
  transparent:true,
  opacity:.9
});

const stars = new THREE.Points(geometry,material);
scene.add(stars);

/* ================== TEXT SPRITE ================== */
let textSprite = null;

function createTextSprite(message){
  const canvas = document.createElement("canvas");
  canvas.width = 1024;
  canvas.height = 512;
  const ctx = canvas.getContext("2d");

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "rgba(255,255,255,0.95)";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.font = "64px serif";

  const lines = message.split("\n");
  lines.forEach((l,i)=>{
    ctx.fillText(
      l,
      canvas.width/2,
      canvas.height/2 + i*72 - (lines.length-1)*36
    );
  });

  const tex = new THREE.CanvasTexture(canvas);
  const mat = new THREE.SpriteMaterial({
    map:tex,
    transparent:true
  });

  const sprite = new THREE.Sprite(mat);
  sprite.scale.set(14,7,1);
  sprite.position.set(0,0,0);
  return sprite;
}

function showText(msg){
  if(textSprite) scene.remove(textSprite);
  textSprite = createTextSprite(msg);
  scene.add(textSprite);
}

/* ================== GESTURE TEXT ================== */
const messages = {
  fist:
"I'm sorry, Dinda.\nI loved you,\nbut not gently enough.",

  palm:
"I never meant\nto turn care\ninto wounds.",

  peace:
"If regret\nhad gravity,\nit would\norbit you forever.",

  thumb:
"I'm learning.\nSlowly.\nStill hoping."
};

/* ================== MEDIAPIPE ================== */
const video = document.getElementById("video");

const hands = new Hands({
  locateFile:file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands:1,
  minDetectionConfidence:.7,
  minTrackingConfidence:.7
});

hands.onResults(res=>{
  if(!res.multiHandLandmarks) return;

  const lm = res.multiHandLandmarks[0];
  const fingers = [
    lm[4].y < lm[3].y,
    lm[8].y < lm[6].y,
    lm[12].y < lm[10].y,
    lm[16].y < lm[14].y,
    lm[20].y < lm[18].y
  ];

  let g="fist";
  if(fingers.every(v=>v)) g="palm";
  else if(fingers[1] && fingers[2] && !fingers[3]) g="peace";
  else if(fingers[0] && !fingers.slice(1).some(v=>v)) g="thumb";

  showText(messages[g]);
});

const cam = new Camera(video,{
  onFrame:async()=>{await hands.send({image:video});},
  width:320,
  height:240
});
cam.start();

/* ================== ANIMATE ================== */
function animate(){
  requestAnimationFrame(animate);

  const pos = geometry.attributes.position.array;
  for(let i=0;i<starCount;i++){
    pos[i*3+2] += speeds[i];
    if(pos[i*3+2]>20) pos[i*3+2]=-20;
  }
  geometry.attributes.position.needsUpdate = true;

  stars.rotation.y += 0.0006;
  stars.rotation.x += 0.0003;

  renderer.render(scene,camera);
}
animate();

/* ================== RESIZE ================== */
addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
