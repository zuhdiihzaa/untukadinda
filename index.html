<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Galaxy Apology</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
  touch-action:none;
}
canvas{
  display:block;
}
#video{
  display:none;
}
</style>

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/geometries/TextGeometry.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/loaders/FontLoader.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

</head>
<body>

<video id="video" playsinline></video>

<script>
/* ================== THREE SETUP ================== */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000010, 10, 40);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
camera.position.z = 18;

const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
document.body.appendChild(renderer.domElement);

/* ================== GALAXY PARTICLES ================== */
const STAR_COUNT = 900; // mobile safe
const starGeo = new THREE.BufferGeometry();
const positions = new Float32Array(STAR_COUNT*3);
const velocities = [];

for(let i=0;i<STAR_COUNT;i++){
  const r = Math.random()*18;
  const theta = Math.random()*Math.PI*2;
  const phi = Math.random()*Math.PI;
  positions[i*3] = r*Math.sin(phi)*Math.cos(theta);
  positions[i*3+1] = r*Math.cos(phi);
  positions[i*3+2] = r*Math.sin(phi)*Math.sin(theta);
  velocities.push(Math.random()*0.002+0.001);
}
starGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));

const starMat = new THREE.PointsMaterial({
  color:0x88aaff,
  size:0.12,
  transparent:true,
  opacity:0.8,
  depthWrite:false
});
const stars = new THREE.Points(starGeo, starMat);
scene.add(stars);

/* ================== LIGHT ================== */
scene.add(new THREE.AmbientLight(0x8899ff,0.6));
const light = new THREE.PointLight(0xaa88ff,1,50);
light.position.set(5,5,10);
scene.add(light);

/* ================== TEXT ================== */
let textMesh;
const fontLoader = new THREE.FontLoader();

const messages = {
  fist: "I'm sorry, Dinda.\nI turned my love\ninto careless wounds.",
  palm: "I never meant to\nmake pain feel familiar\nto your heart.",
  peace: "If regret had a sound,\nit would whisper\nyour name every night.",
  thumb: "I am learning.\nSlowly.\nFor you.\nFor us."
};

function createText(content){
  if(textMesh) scene.remove(textMesh);

  fontLoader.load("https://threejs.org/examples/fonts/helvetiker_regular.typeface.json", font=>{
    const geo = new THREE.TextGeometry(content,{
      font,
      size:1.2,
      height:0.4,
      curveSegments:8
    });
    geo.center();

    const mat = new THREE.MeshStandardMaterial({
      color:0xffffff,
      metalness:0.3,
      roughness:0.2
    });

    textMesh = new THREE.Mesh(geo,mat);
    textMesh.position.z = -2;
    scene.add(textMesh);
  });
}

/* ================== TRANSITION ================== */
let exploding = false;
let transitionProgress = 0;

function triggerTransition(text){
  exploding = true;
  transitionProgress = 0;
  createText(text);
}

/* ================== ANIMATE ================== */
function animate(){
  requestAnimationFrame(animate);

  // galaxy idle rotation
  stars.rotation.y += 0.0008;
  stars.rotation.x += 0.0003;

  const pos = starGeo.attributes.position.array;

  for(let i=0;i<STAR_COUNT;i++){
    pos[i*3+1] += Math.sin(Date.now()*0.0005+i)*0.0003;
  }

  // transition animation
  if(exploding){
    transitionProgress += 0.03;
    for(let i=0;i<STAR_COUNT;i++){
      pos[i*3] *= (1-0.02);
      pos[i*3+1] *= (1-0.02);
      pos[i*3+2] *= (1-0.02);
    }
    if(transitionProgress>1){
      exploding = false;
    }
  }

  starGeo.attributes.position.needsUpdate = true;

  renderer.render(scene,camera);
}
animate();

/* ================== HAND TRACKING ================== */
const video = document.getElementById("video");

const hands = new Hands({
  locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands:1,
  modelComplexity:0,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

let lastGesture = "";

hands.onResults(res=>{
  if(!res.multiHandLandmarks.length) return;
  const lm = res.multiHandLandmarks[0];

  const isFist = lm[8].y > lm[6].y && lm[12].y > lm[10].y;
  const isPalm = lm[8].y < lm[6].y && lm[12].y < lm[10].y;
  const isPeace = lm[8].y < lm[6].y && lm[12].y < lm[10].y && lm[16].y > lm[14].y;
  const isThumb = lm[4].y < lm[3].y;

  let gesture = "";
  if(isFist) gesture="fist";
  else if(isPalm) gesture="palm";
  else if(isPeace) gesture="peace";
  else if(isThumb) gesture="thumb";

  if(gesture && gesture!==lastGesture){
    triggerTransition(messages[gesture]);
    lastGesture = gesture;
  }
});

const cam = new Camera(video,{
  onFrame:async()=>await hands.send({image:video}),
  width:640,
  height:480
});
cam.start();

window.addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>
