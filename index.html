<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>For Dinda</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
  font-family:system-ui,sans-serif;
}
canvas{display:block}

#cam{
  position:fixed;
  right:12px;
  bottom:12px;
  width:110px;
  height:160px;
  object-fit:cover;
  border-radius:14px;
  opacity:.18;
  filter:blur(.6px);
  pointer-events:none;
  transition:opacity .8s ease;
  z-index:5;
}

#hint{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  font-size:12px;
  color:rgba(255,255,255,.22);
  letter-spacing:.4px;
  z-index:4;
  user-select:none;
}
</style>
</head>

<body>
<video id="cam" autoplay playsinline muted></video>
<div id="hint">✋ open · ✊ close</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/geometries/TextGeometry.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ===== THREE ===== */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x050010,8,28);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,100);
camera.position.z=12;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
document.body.appendChild(renderer.domElement);

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* ===== STARS ===== */
const starCount=1800;
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(starCount*3);

for(let i=0;i<starCount;i++){
  pos[i*3]=(Math.random()-.5)*30;
  pos[i*3+1]=(Math.random()-.5)*30;
  pos[i*3+2]=(Math.random()-.5)*30;
}
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const mat=new THREE.PointsMaterial({
  color:0xffffff,
  size:.04,
  transparent:true,
  opacity:.9,
  depthWrite:false
});

const stars=new THREE.Points(geo,mat);
scene.add(stars);

/* ===== LIGHT ===== */
scene.add(new THREE.PointLight(0xff88ff,1.4,20));
scene.add(new THREE.AmbientLight(0x333344));

/* ===== TEXT ===== */
let textMesh=null;

function showText(){
  const loader=new THREE.FontLoader();
  loader.load(
    "https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",
    font=>{
      const tg=new THREE.TextGeometry(
        "I am sorry, Dinda.\nFor the times my love\narrived as pain,\nnot care.",
        {
          font:font,
          size:.6,
          height:.25,
          curveSegments:12,
          bevelEnabled:true,
          bevelThickness:.03,
          bevelSize:.02,
          bevelSegments:5
        }
      );
      tg.center();

      const tm=new THREE.MeshStandardMaterial({
        color:0xffd9ff,
        emissive:0x662266,
        emissiveIntensity:.9,
        roughness:.2,
        metalness:.1
      });

      textMesh=new THREE.Mesh(tg,tm);
      textMesh.position.z=-1;
      scene.add(textMesh);

      cam.style.opacity=.18;
    }
  );
}

/* ===== STATE ===== */
let state="idle";
function trigger(){
  if(state!=="idle")return;
  state="gather";
  cam.style.opacity=0;
}
function reset(){
  if(textMesh){
    scene.remove(textMesh);
    textMesh=null;
  }
  state="idle";
}

/* ===== LOOP ===== */
function animate(){
  requestAnimationFrame(animate);

  stars.rotation.y+=.0006;
  stars.rotation.x+=.0003;

  const a=geo.attributes.position.array;

  if(state==="gather"){
    for(let i=0;i<starCount;i++){
      a[i*3]*=.96;
      a[i*3+1]*=.96;
      a[i*3+2]*=.96;
    }
    geo.attributes.position.needsUpdate=true;
    if(Math.abs(a[0])<.02) state="explode";
  }

  if(state==="explode"){
    for(let i=0;i<starCount;i++){
      a[i*3]+=(Math.random()-.5)*.6;
      a[i*3+1]+=(Math.random()-.5)*.6;
      a[i*3+2]+=(Math.random()-.5)*.6;
    }
    geo.attributes.position.needsUpdate=true;
    state="text";
    showText();
  }

  renderer.render(scene,camera);
}
animate();

/* ===== MEDIAPIPE ===== */
const cam=document.getElementById("cam");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:0,
  minDetectionConfidence:.6,
  minTrackingConfidence:.6
});

hands.onResults(r=>{
  if(!r.multiHandLandmarks) return;

  const lm=r.multiHandLandmarks[0];
  if(!lm || lm.length<13) return;   // ✅ FIX CRASH

  const open =
    lm[8].y < lm[6].y &&
    lm[12].y < lm[10].y;

  const fist =
    lm[8].y > lm[6].y &&
    lm[12].y > lm[10].y;

  if(open) trigger();
  if(fist) reset();
});

new Camera(cam,{
  onFrame:()=>hands.send({image:cam}),
  width:640,
  height:480
}).start();
</script>
</body>
</html>
