<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Galaxy Apology</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
  touch-action:none;
  font-family:system-ui;
}
canvas{display:block;}
#video{
  position:fixed;
  left:12px;
  bottom:12px;
  width:120px;
  height:160px;
  object-fit:cover;
  border-radius:12px;
  opacity:.85;
  transform:scaleX(-1);
  z-index:5;
}
#hint{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  color:#9bbcff;
  font-size:12px;
  opacity:.6;
  text-align:center;
  z-index:6;
}
</style>

<!-- THREE CORE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155/build/three.min.js"></script>

<!-- THREE EXAMPLES (GLOBAL / NON-MODULE) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155/examples/js/geometries/TextGeometry.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>

<body>
<video id="video" autoplay playsinline muted></video>
<div id="hint">‚úä ‚úã ‚úåÔ∏è üëç ‚Äî change the sky</div>

<script>
/* ===================== SCENE ===================== */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x050014,12,40);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,100);
camera.position.z=18;

const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(2,devicePixelRatio));
document.body.appendChild(renderer.domElement);

/* ===================== LIGHT ===================== */
scene.add(new THREE.AmbientLight(0x8899ff,.55));
const glow=new THREE.PointLight(0xaa88ff,1.3,50);
glow.position.set(5,6,12);
scene.add(glow);

/* ===================== GALAXY ===================== */
const STAR_COUNT=850;
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(STAR_COUNT*3);
const base=[];

for(let i=0;i<STAR_COUNT;i++){
  const r=Math.random()*18;
  const t=Math.random()*Math.PI*2;
  const p=Math.random()*Math.PI;
  const x=r*Math.sin(p)*Math.cos(t);
  const y=r*Math.cos(p);
  const z=r*Math.sin(p)*Math.sin(t);
  pos.set([x,y,z],i*3);
  base.push({x,y,z});
}
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const stars=new THREE.Points(
  geo,
  new THREE.PointsMaterial({
    color:0x88aaff,
    size:.13,
    opacity:.85,
    transparent:true,
    depthWrite:false
  })
);
scene.add(stars);

/* ===================== TEXT ===================== */
let textMesh=null;
const fontLoader=new THREE.FontLoader();

const messages={
  fist:"I'm sorry, Dinda.\nI let my love\nbecome careless.",
  palm:"I never wanted\nyour heart to learn\nhow pain feels.",
  peace:"If regret had gravity,\nit would orbit\nyou forever.",
  thumb:"I'm learning.\nSlowly.\nFor you.\nFor us."
};

function spawnText(content){
  if(textMesh) scene.remove(textMesh);

  fontLoader.load(
    "https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",
    font=>{
      const g=new THREE.TextGeometry(content,{
        font,
        size:1.15,
        height:.45,
        bevelEnabled:true,
        bevelThickness:.05,
        bevelSize:.03,
        curveSegments:8
      });
      g.center();
      const m=new THREE.MeshStandardMaterial({
        color:0xffffff,
        metalness:.35,
        roughness:.25,
        emissive:0x222244
      });
      textMesh=new THREE.Mesh(g,m);
      textMesh.position.z=-3;
      textMesh.scale.set(.01,.01,.01);
      scene.add(textMesh);
    }
  );
}

/* ===================== TRANSITION ===================== */
let transitioning=false,t=0;
function trigger(content){
  transitioning=true;
  t=0;
  spawnText(content);
}

function animateTransition(){
  if(!transitioning)return;
  t+=.03;
  for(let i=0;i<STAR_COUNT;i++){
    pos[i*3]*=.92;
    pos[i*3+1]*=.92;
    pos[i*3+2]*=.92;
  }
  if(textMesh){
    const s=Math.min(1,t);
    textMesh.scale.set(s,s,s);
  }
  if(t>1){
    transitioning=false;
    base.forEach((b,i)=>{
      pos[i*3]=b.x;
      pos[i*3+1]=b.y;
      pos[i*3+2]=b.z;
    });
  }
}

/* ===================== LOOP ===================== */
function animate(){
  requestAnimationFrame(animate);
  stars.rotation.y+=.0007;
  stars.rotation.x+=.0003;
  for(let i=0;i<STAR_COUNT;i++){
    pos[i*3+1]+=Math.sin(Date.now()*0.0004+i)*0.00025;
  }
  animateTransition();
  geo.attributes.position.needsUpdate=true;
  renderer.render(scene,camera);
}
animate();

/* ===================== HAND TRACKING ===================== */
const video=document.getElementById("video");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:0,
  minDetectionConfidence:.7,
  minTrackingConfidence:.7
});

let last="";
hands.onResults(r=>{
  if(!r.multiHandLandmarks.length)return;
  const l=r.multiHandLandmarks[0];
  const fist=l[8].y>l[6].y&&l[12].y>l[10].y;
  const palm=l[8].y<l[6].y&&l[12].y<l[10].y;
  const peace=palm&&l[16].y>l[14].y;
  const thumb=l[4].y<l[3].y;

  let g="";
  if(fist)g="fist";
  else if(peace)g="peace";
  else if(palm)g="palm";
  else if(thumb)g="thumb";

  if(g&&g!==last){
    trigger(messages[g]);
    last=g;
  }
});

const cam=new Camera(video,{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480
});
cam.start();

/* ===================== RESIZE ===================== */
addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
