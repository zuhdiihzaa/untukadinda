<script>
const canvas=c;
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
resize();addEventListener("resize",resize);

let currentState="idle";

/* ===== PARTICLES ===== */
const COUNT=2400;
const TEXT_PORTION=0.55; // lebih banyak untuk teks
const particles=[],base=[];

for(let i=0;i<COUNT;i++){
  const p={
    x:(Math.random()-.5)*canvas.width,
    y:(Math.random()-.5)*canvas.height,
    z:Math.random()*900,
    drift:(Math.random()*0.6+0.2),
    seed:Math.random()*1000
  };
  particles.push(p);
  base.push({...p});
}

/* ===== TEXT ===== */
function makeText(text){
  const off=document.createElement("canvas");
  const o=off.getContext("2d");
  off.width=canvas.width;
  off.height=canvas.height;

  const fs=canvas.width*(canvas.height>canvas.width?0.07:0.05);
  o.fillStyle="#fff";
  o.textAlign="center";
  o.textBaseline="middle";
  o.font=`700 ${fs}px Georgia`;

  const lines=text.split("\n");
  const lh=fs*1.4;
  const sy=off.height/2-(lines.length-1)*lh/2;
  lines.forEach((l,i)=>o.fillText(l,off.width/2,sy+i*lh));

  const d=o.getImageData(0,0,off.width,off.height).data;
  const arr=[],step=2; // lebih rapat biar jelas
  for(let y=0;y<off.height;y+=step){
    for(let x=0;x<off.width;x+=step){
      if(d[(y*off.width+x)*4+3]>120){
        arr.push({x:x-off.width/2,y:y-off.height/2,z:0});
      }
    }
  }
  return arr;
}

/* ===== HEART ===== */
function makeHeart(){
  const arr=[];
  for(let t=0;t<Math.PI*2;t+=0.03){
    const x=16*Math.sin(t)**3;
    const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    arr.push({x:x*13,y:-y*13,z:0});
  }
  return arr;
}

/* ===== TARGETS ===== */
const TARGETS={
  fist: makeText("from someone who keeps failing you"),
  one: makeText(`Dear Adinda,

I am truly sorry
for disappointing you
again and again.`),
  two: makeText(`You never deserved
the pain I caused,
and I regret it deeply.`),
  three: makeText(`If apologies could heal wounds,
I would whisper them
to you forever.`),
  four: makeHeart(),
  five: makeText(`Still hoping
for your forgiveness â™¥`)
};

/* ===== NOISE FLOW (lebih natural) ===== */
function flow(x,y,t){
  return Math.sin(x*0.002+t)+Math.cos(y*0.002-t);
}

/* ===== ANIMATION ===== */
let t=0;
function animate(){
  t+=0.003;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* soft nebula glow */
  const g=ctx.createRadialGradient(
    canvas.width/2,canvas.height/2,0,
    canvas.width/2,canvas.height/2,canvas.width
  );
  g.addColorStop(0,"#1a0033");
  g.addColorStop(1,"#000");
  ctx.fillStyle=g;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.translate(canvas.width/2,canvas.height/2);

  const target=TARGETS[currentState];
  const textLimit = target ? Math.floor(COUNT * TEXT_PORTION) : 0;

  particles.forEach((p,i)=>{
    let tx,ty,tz;

    if(target && i < textLimit && i < target.length){
      tx=target[i].x;
      ty=target[i].y;
      tz=0;
    }else{
      const f=flow(p.x,p.y,t+p.seed);
      tx=base[i].x + Math.cos(f)*80;
      ty=base[i].y + Math.sin(f)*80;
      tz=base[i].z;
    }

    p.x+=(tx-p.x)*0.07;
    p.y+=(ty-p.y)*0.07;
    p.z+=(tz-p.z)*0.07;

    const s=700/(700+p.z);

    /* teks lebih terang */
    const isText = target && i < textLimit && i < target.length;
    const r=isText?3.2*s:2.2*s;

    const glow=ctx.createRadialGradient(p.x*s,p.y*s,0,p.x*s,p.y*s,r);
    glow.addColorStop(0,isText?"rgba(255,255,255,1)":"rgba(200,220,255,0.9)");
    glow.addColorStop(1,"rgba(150,180,255,0)");

    ctx.beginPath();
    ctx.fillStyle=glow;
    ctx.arc(p.x*s,p.y*s,r,0,Math.PI*2);
    ctx.fill();
  });

  ctx.setTransform(1,0,0,1,0,0);
  requestAnimationFrame(animate);
}
animate();
</script>
