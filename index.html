<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>For Dinda</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
}
canvas{display:block}
#video{
  position:fixed;
  left:12px;
  bottom:12px;
  width:110px;
  height:150px;
  object-fit:cover;
  border-radius:12px;
  opacity:.85;
  transform:scaleX(-1);
  z-index:5;
}
#hint{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  color:#9bbcff;
  font-size:12px;
  opacity:.6;
  z-index:6;
}
</style>

<!-- ‚úÖ THREE JS (STABLE) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.149.0/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.149.0/examples/js/geometries/TextGeometry.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>

<body>
<video id="video" autoplay muted playsinline></video>
<div id="hint">‚úä ‚úã ‚úåÔ∏è üëç ‚Äî change the sky</div>

<script>
/* ================= SCENE ================= */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x050014,10,40);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,100);
camera.position.z=18;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(2,devicePixelRatio));
document.body.appendChild(renderer.domElement);

/* ================= LIGHT ================= */
scene.add(new THREE.AmbientLight(0x8899ff,.6));
const light=new THREE.PointLight(0xaa88ff,1.2,40);
light.position.set(5,6,10);
scene.add(light);

/* ================= GALAXY ================= */
const count=800;
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(count*3);
const base=[];

for(let i=0;i<count;i++){
  const r=Math.random()*18;
  const t=Math.random()*Math.PI*2;
  const p=Math.random()*Math.PI;
  const x=r*Math.sin(p)*Math.cos(t);
  const y=r*Math.cos(p);
  const z=r*Math.sin(p)*Math.sin(t);
  pos.set([x,y,z],i*3);
  base.push({x,y,z});
}
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const stars=new THREE.Points(
  geo,
  new THREE.PointsMaterial({
    color:0x88aaff,
    size:.14,
    transparent:true,
    opacity:.85
  })
);
scene.add(stars);

/* ================= TEXT ================= */
let textMesh=null;
const loader=new THREE.FontLoader();

const texts={
  fist:"I'm sorry, Dinda.\nI let my love\nbe careless.",
  palm:"I never meant\nto turn love\ninto pain.",
  peace:"If regret\nhad gravity,\nit would\norbit you.",
  thumb:"I'm learning.\nSlowly.\nFor you."
};

function showText(msg){
  if(textMesh) scene.remove(textMesh);

  loader.load(
    "https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",
    font=>{
      const g=new THREE.TextGeometry(msg,{
        font,
        size:1.1,
        height:.4,
        bevelEnabled:true,
        bevelThickness:.05,
        bevelSize:.03
      });
      g.center();
      const m=new THREE.MeshStandardMaterial({
        color:0xffffff,
        metalness:.3,
        roughness:.25,
        emissive:0x222244
      });
      textMesh=new THREE.Mesh(g,m);
      textMesh.position.z=-3;
      textMesh.scale.set(.01,.01,.01);
      scene.add(textMesh);
    }
  );
}

/* ================= TRANSITION ================= */
let trans=false,t=0;
function trigger(msg){
  trans=true;
  t=0;
  showText(msg);
}

function animateTrans(){
  if(!trans)return;
  t+=.03;
  for(let i=0;i<count;i++){
    pos[i*3]*=.92;
    pos[i*3+1]*=.92;
    pos[i*3+2]*=.92;
  }
  if(textMesh){
    const s=Math.min(1,t);
    textMesh.scale.set(s,s,s);
  }
  if(t>1){
    trans=false;
    base.forEach((b,i)=>{
      pos[i*3]=b.x;
      pos[i*3+1]=b.y;
      pos[i*3+2]=b.z;
    });
  }
}

/* ================= LOOP ================= */
function animate(){
  requestAnimationFrame(animate);
  stars.rotation.y+=.0006;
  stars.rotation.x+=.0003;
  animateTrans();
  geo.attributes.position.needsUpdate=true;
  renderer.render(scene,camera);
}
animate();

/* ================= HAND TRACK ================= */
const video=document.getElementById("video");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:0,
  minDetectionConfidence:.7,
  minTrackingConfidence:.7
});

let last="";
hands.onResults(r=>{
  if(!r.multiHandLandmarks.length)return;
  const l=r.multiHandLandmarks[0];
  const fist=l[8].y>l[6].y;
  const palm=l[8].y<l[6].y && l[12].y<l[10].y;
  const peace=palm && l[16].y>l[14].y;
  const thumb=l[4].y<l[3].y;

  let g="";
  if(fist)g="fist";
  else if(peace)g="peace";
  else if(palm)g="palm";
  else if(thumb)g="thumb";

  if(g && g!==last){
    trigger(texts[g]);
    last=g;
  }
});

const cam=new Camera(video,{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480
});
cam.start();

/* ================= RESIZE ================= */
addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
